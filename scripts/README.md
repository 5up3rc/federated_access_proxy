# OpenSSH PKI


NOTE: For the access proxy use-case, user keys are generated by the access proxy itself instead of the user. If using this for a more typical scenario, you
may be signing keys only instead of also generating them on behalf of the user.

## Host CA
The host CA (certification authority) is created so that clients can trust hosts they've never connected to, by trusting the CA public key.
This is basically the `known_hosts` functionality but using a CA. All server host keys that want this functionality need to be approved and signed by the host CA.
This functionality is NOT required to user client certificate authentication.
The CA signature usually expires thus it is needed to sign the server's host keys again periodically.

### How does this work?
1) Run `01_gen_ca.sh` to create an Host CA if you wish to use that functionality.
2) Run `03_sign_host_keys.sh example.com example_host_key` to sign the host key of the server you want to trust.
3) Copy the resulting `ssh_host_ed25519_key-cert.pub` to `/etc/ssh/ssh_host_ed25519_key-cert.pub`.
4) Modify the server's configuration in `/etc/ssh/sshd_config` to include: `HostCertificate /etc/ssh/ssh_host_ed25519_key-cert.pub`
5) Reload the server's sshd: `systemctl reload sshd`
6) Instruct users/clients to trust the CA by sending them `/etc/ssh/ca_host_key.pub` and editing their `~/.ssh/known_hosts` file with this additional line:
  `@cert-authority *.example.com <contents of ca_host_key.pub here>`
  Replace `*.example.com` by your server or server's hostnames as well.

## User CA
The user CA (certification authority), or "client certificates CA" is created so that servers can trust clients/user's who's key has been signed by the CA.
This usually supersedes "SSH private keys" though both may be used at the same time. The servers trust the CA public key, and thus all client/user keys that are signed by it,
without having to have prior knowledge of these keys.
The CA signature of the client/user key usually expires (and this is strongly recommended) thus it is needed to sign the client/user's keys again periodically.

### How does this work?
1) Run `02_gen_user_ca.sh` to create a User CA if you wish to use that functionality (usually, you do).
2) Copy the public key `ca_user_key.pub` to the SSH server in `/etc/ssh/ca_user_key.pub`
3) Run `04_gen_signed_client_key.sh gdestuynder@moilla.com` to generate a signed user key (note: you can also sign user-generated keys, depending on the use-case)
4) Modify the server's configuration in `/etc/ssh/sshd_config` to include: `TrustedUserCAKeys /etc/ssh/ca_user_key.pub`
5) Reload the server's sshd: `systemctl reload sshd`
6) Load the generated user key in the user's ssh-agent (note: you can also just instruct the user to use their key if it was self-generated)
